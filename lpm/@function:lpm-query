function lpm_query(id as long, cmd as string, param as long) as string * 2233
    '' NOTE: param = -1 omits parameter
    dim value as long

    select case param
    case -1
        sprintf(lpm_command, "%02d%s", id, uppercase(cmd))
    case 0 to 99999
        sprintf(lpm_command, "%02d%s%05d", id, uppercase(cmd), param)
    case else
        lpm_err_msg = "rejected: invalid parameter" : lpm_command="" : lpm_results=""
        return QUESTION & QUESTION & lpm_err_msg
    endselect

    serialOut(LPM__PORT, CR & lpm_command & CR,"",0,0)
    
    select case uppercase(cmd)
    case "TR"
        serialIn(lpm_results,LPM__PORT,300,ETX,2233)
    case "??"
        serialIn(lpm_results,LPM__PORT,30,LF,2233)
        '' output begins with "User commands", so look for "U" below
    case else
        serialin(lpm_results,LPM__PORT,300,CR,80)
        lpm_results = mid(lpm_results, 1, len(lpm_results))
    endselect

    select case left(lpm_results,1)
    case BANG
        '' examples: "!00BR00005", "!00CI00002"
        select case mid(lpm_results,4,2)
        case "CI"
            lpm_err_msg = lpm_results
            select case right(lpm_results,1)
            case 0  : lpm_err_msg &= ": invalid parameter"      '' !00CI00000
            case 2  : lpm_err_msg &= ": unknown command"        '' !00CI00002
            case 4  : lpm_err_msg &= ": parameter out of range" '' !00CI00004
            case 8  : lpm_err_msg &= ": config mode required"   '' !00CI00008
            endselect
            return QUESTION & lpm_err_msg
        case uppercase(cmd)
            '' command confirmed, so return numeric parameter
            value = mid(lpm_results,6,5)
            lpm_err_msg = ""
            return value
        case else
            lpm_err_msg = "unexpected:" & lpm_results
            return QUESTION & QUESTION & lpm_err_msg
        endselect
    case STX
        '' framed telegram output with checksum
        lpm_checksum = lpm_calc_cksum(lpm_results)
        if (lpm_checksum and &h0FF) = 0 then
            lpm_err_msg = ""
            return lpm_results
        else
            lpm_results = QUESTION & mid(lpm_results,2,2233)
            sprintf(msg,"DEBUG: %s, length: %d, checksum bad: 0x%X", _
                    lpm_command, len(lpm_results), lpm_checksum)
            calltable Messages
            lpm_err_msg = "telegram checksum failed"
        endif
    case "U"
        '' LPM help output from "??" command starts with "User commands:"
        lpm_err_msg = ""
        return lpm_results
    case else
        '' simple data output from DD, DX, FM, PT, DA, ZT
        lpm_err_msg = ""
        return lpm_results
    endselect
endfunction
